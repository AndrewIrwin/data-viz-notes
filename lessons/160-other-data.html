<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>34&nbsp; Beyond tidy data – Data Visualization notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../lessons/130-graphics-output.html" rel="next">
<link href="../lessons/133-themes.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-485d01fc63b59abcd3ee1bf1e8e2748d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../lessons/160-other-data.html"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Beyond tidy data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Data Visualization notes</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/101-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Invitation to Data Visualization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/102-intro-to-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Computer tools</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/103-setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Setting up your computer</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/104-look-at-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Look at data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/105-first-plot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Making your first plot</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/106-version-control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">What is version control software?</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/302-staying-organized.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Staying organized</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/107-grammar-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Grammar of Graphics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/108-ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Using the grammar of graphics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/110-summarizing-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Summarizing data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/115-facets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Facetted graphs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/106b-using-LLM-to-learn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Using AI to learn</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/111-reading-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Reading data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/112-reshaping-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Reshaping data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/113-data-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Format tables</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/114-asking-questions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Getting help and asking questions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/118-working-with-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Working with models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/119-linear-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Linear models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/120-gam-loess.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">GAM and LOESS smoothing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/124-collaboration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Collaborating with GitHub</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/301-data-sources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Finding and accessing data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/911-ethics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Accessibility, Bias, and Ethics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/133-reproducible-reports.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Reproducible reports</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/121-PCA.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Principal component analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/122-mds.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Multidimensional scaling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/123-kmean.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">K-means clustering</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/125-slides.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Making slides for presentations</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/127-test-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Checking your work</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/155-dynamics-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Dynamic graphics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/140-mapping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Making maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/141-mapping-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Mapping II</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/142-mapping-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Alternatives to maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/130-bonus-topics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Working with text, factors, dates and times</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/201-colour.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Using colour well</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/133-themes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Themes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/160-other-data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Beyond tidy data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/130-graphics-output.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Graphics formatting</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/134-reconstruction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Reconstructing a visualization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/499-review.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R Review</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/901-TMI-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">More details about R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lessons/999-metadata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metadata</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#relational-data" id="toc-relational-data" class="nav-link active" data-scroll-target="#relational-data"><span class="header-section-number">34.1</span> Relational data</a>
  <ul class="collapse">
<li><a href="#example-with-airline-flight-data" id="toc-example-with-airline-flight-data" class="nav-link" data-scroll-target="#example-with-airline-flight-data"><span class="header-section-number">34.1.1</span> Example with airline flight data</a></li>
  </ul>
</li>
  <li><a href="#irregular-data" id="toc-irregular-data" class="nav-link" data-scroll-target="#irregular-data"><span class="header-section-number">34.2</span> Irregular data</a></li>
  <li>
<a href="#beyond-csv-other-data-formats" id="toc-beyond-csv-other-data-formats" class="nav-link" data-scroll-target="#beyond-csv-other-data-formats"><span class="header-section-number">34.3</span> Beyond CSV: other data formats</a>
  <ul class="collapse">
<li><a href="#frictionless-metadata-for-tables" id="toc-frictionless-metadata-for-tables" class="nav-link" data-scroll-target="#frictionless-metadata-for-tables"><span class="header-section-number">34.3.1</span> Frictionless metadata for tables</a></li>
  <li><a href="#csvw" id="toc-csvw" class="nav-link" data-scroll-target="#csvw"><span class="header-section-number">34.3.2</span> CSVW</a></li>
  <li><a href="#speed-and-metadata-solution" id="toc-speed-and-metadata-solution" class="nav-link" data-scroll-target="#speed-and-metadata-solution"><span class="header-section-number">34.3.3</span> Speed and metadata solution</a></li>
  </ul>
</li>
  <li><a href="#packages-used" id="toc-packages-used" class="nav-link" data-scroll-target="#packages-used"><span class="header-section-number">34.4</span> Packages used</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">34.5</span> References</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Beyond tidy data</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>Throughout this course we have been using tidy data: every dataset is a table organized so that each column is a variable and each row is an observation. This design is very convenient for data visualizations and data analysis. The format makes it easy to associate a column with an aesthetic on a graph, a predictor or response variable in a regression, or a dimension in a clustering or multivariate analysis.</p>
<p>There are at least two important ways many data sets differ from this tidy format: there may be multiple tables that are related to each other, known as relational data, or the data can be more irregular than a rectangular table. These formats can be reshaped into rectangular tidy data, but at a cost of some repetition or creating missing values, both of which make the data larger to store and often harder to change or update.</p>
<p>In this lesson I will show you an example of each dataset, explain why the non-tidy formats are useful, and show you how to reshape the data for the tools we have studied in this course which demand tidy (rectangular) data.</p>
<p>Another reason databases are used is that they provide tools for working with very large datasets, including data which are too large to hold in the working memory of one computer. A useful distinction in computing is between</p>
<ol type="1">
<li>long-term storage: the relatively slow, but large capacity to store data “permanently”, meaning after the computer is turned off, and</li>
<li>working storage: data that can be accessed thousands of times faster than slow storage, but is relatively scarce; sometimes your computer will move data from working storage to long-term storage to complete the task you have set, slowing its work down while making the task possible.</li>
</ol>
<p>Long-term storage is commonly called “disk” (floppy disk, hard disk, solid state drive as technologies change) and working storage is commonly called RAM (random access memory). We talk about “saving” data in “files” on disk, and “reading” data from long-term storage into working storage. When you purchase a computer you make decisions about the relative amount of each to get; commonly a consumer-grade computer has 8-16 GB of RAM and 256-1024 GB (32-128 times more) disk. When you use a cell phone or a service accessed through the browser, these distinctions are blurred and you often have no idea how much RAM you can access, you just know the capacity of the service for long-term storage. This simplification is generally a good thing.</p>
<p>We have used comma separated values (CSV) format data throughout the course because the format is very widely used and easy to understand. There are some drawbacks to this format which can been addressed by storing tidy table data in other formats when saving data to files on a disk. Regardless of the long-term storage format, we aim to use the same tools in R to work with the data (data tables, tidyverse functions), but there are some special details when working with very large data, even data that are too large for your computer’s working storage.</p>
<section id="relational-data" class="level2" data-number="34.1"><h2 data-number="34.1" class="anchored" data-anchor-id="relational-data">
<span class="header-section-number">34.1</span> Relational data</h2>
<p>The classic example of relational data is a business with a list of products, a list of customers, and a combination of both describing sales of products to customers. Another common example is a list of students, a list of courses, and a list of courses taken by students (and their grades or other registration data).</p>
<p>In both of these cases, you can see that there are data sets that are independent of each other (products and customers; students and courses) and very important relationships between the two tables of data (products sold to customers, courses taken by students).</p>
<p>To flesh out the examples a bit more, imagine you are describing a list of courses, a list of students, a timetable, and the registration records. You might create three data tables with the following data</p>
<ul>
<li>Courses
<ul>
<li>Course ID (STAT 2430)</li>
<li>Course name (Data visualization)</li>
<li>Prerequisites, Course description, etc.</li>
</ul>
</li>
<li>Students
<ul>
<li>Student ID</li>
<li>Student name</li>
<li>Program of study, registration status, etc.</li>
</ul>
</li>
<li>Time table
<ul>
<li>Course ID</li>
<li>Year and Term</li>
<li>Room number</li>
<li>Maximum enrollment</li>
<li>Class meeting times</li>
</ul>
</li>
<li>Registration data
<ul>
<li>Course ID</li>
<li>Student ID</li>
<li>Year and Term</li>
<li>Grade</li>
</ul>
</li>
</ul>
<p>Notice that the variables Student ID, Course ID, and Year and Term each appear in multiple tables and will be used to connect the data from different tables together. All of the data could be in a single table, with every row having a student, course, and time; but you’d need to have a lot of duplicated information. Some tasks like preparing the timetable wouldn’t fit into a single table well since there would be no students registered when the course was first created. Having four separate tables is a much more convenient way to represent these data.</p>
<p>Another example is a list of books, authors, publishers, and libraries that bought the book:</p>
<ul>
<li>Books
<ul>
<li>Book ID number (e.g., <a href="https://en.wikipedia.org/wiki/ISBN">ISBN</a>)</li>
<li>Book title</li>
<li>Publisher</li>
<li>Publication date</li>
<li>Author list (using ID numbers – no practical ID system exists for book authors)</li>
</ul>
</li>
<li>Authors
<ul>
<li>Author name</li>
<li>Author ID</li>
</ul>
</li>
<li>Publisher
<ul>
<li>Publisher name</li>
<li>Publisher address, website, other contact information</li>
<li>Publisher ID (The first few digits of an ISBN identify the publisher; the remaining digits identify a specific book)</li>
</ul>
</li>
<li>Library
<ul>
<li>Library name</li>
<li>Book ID of purchased books</li>
<li>Is book in library, or checked out</li>
<li>Last date the book was checked out</li>
</ul>
</li>
</ul>
<p>Incidentally, a similar database structure would work for academic research articles. In the last few years, international standards for author ID numbers (<a href="https://en.wikipedia.org/wiki/ORCID">ORCID</a>) and publication ID numbers (<a href="https://www.doi.org/the-identifier/what-is-a-doi/">DOI</a>) have been developed to facilitate this sort of database construction.</p>
<p>Each of these data structures is more complicated than the simple tables that we have used in this course. Generally managing these sort of data is done with a relational database. Software for relational databases provides ways to combine data from different tables together (“join” the data) and validate data to be sure for example that a book is only created using valid author and publisher IDs. R has tools for working with many different databases and their software. Fortunately databases are standardized enough that many of the common functions are available using a common syntax and this matches the <code>dplyr</code> tools we have been using nearly perfectly.</p>
<section id="example-with-airline-flight-data" class="level3" data-number="34.1.1"><h3 data-number="34.1.1" class="anchored" data-anchor-id="example-with-airline-flight-data">
<span class="header-section-number">34.1.1</span> Example with airline flight data</h3>
<p>Here we will work with data on flights in and out of New York City, in a database. There are five separate tables: airlines, airports, planes, flights, and weather.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/">dbplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13">nycflights13</a></span><span class="op">)</span></span>
<span><span class="va">nyc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/nycflights13.html">nycflights13_sqlite</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">airlines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">nyc</span>, <span class="st">"airlines"</span><span class="op">)</span></span>
<span><span class="va">airports</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">nyc</span>, <span class="st">"airports"</span><span class="op">)</span></span>
<span><span class="va">airplanes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">nyc</span>, <span class="st">"planes"</span><span class="op">)</span></span>
<span><span class="va">flights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">nyc</span>, <span class="st">"flights"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Take a few minutes to familiarize yourself with each of these tables. You’ll notice that they are not like normal tables (or tibbles) in R. The number of rows is unknown (reported as ??). This is because the data are not read into R; you simply have access to them to make queries (using dplyr, which is translated into SQL for you.) This is convenient because there are 16 airlines, 3322 airplanes, 1458 airports, and 336,776 flights.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">airports</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [?? x 1]
# Database: sqlite 3.51.1 [/var/folders/nm/s3fqdtfj4_vd34n3855h_6j80000gn/T//Rtmp2elTX3/nycflights13.sqlite]
      n
  &lt;int&gt;
1  1458</code></pre>
</div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [?? x 1]
# Database: sqlite 3.51.1 [/var/folders/nm/s3fqdtfj4_vd34n3855h_6j80000gn/T//Rtmp2elTX3/nycflights13.sqlite]
       n
   &lt;int&gt;
1 336776</code></pre>
</div>
</div>
<p>You should notice that there are common variables between some pairs of tables:</p>
<ul>
<li>airplanes and flights have codes to identify each airplane (tailnum)</li>
<li>airports and flights three letter codes for airports (faa, origin, dest)</li>
<li>airlines and flights have two letter codes for the airline (carrier)</li>
</ul>
<p>These allow the details of each airport, airline, and airplane to be connected to data about each flights.</p>
<p>We can use these tables to find all the United Airlines (“UA”) flights to Minneapolis (“MSP”) on an Embrarer 145 (EMB-145, EMB-145LR, EMB-145XR).</p>
<p>First, let’s get the United Airlines flights to Minneapolis (operated by their subsiduary ExpressJet Airlines Inc.):</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flights_ev_msp</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">carrier</span> <span class="op">==</span> <span class="st">"EV"</span>, <span class="va">dest</span> <span class="op">==</span> <span class="st">"MSP"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can get all the Embraer airplanes:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">airplanes</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">model</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">==</span> <span class="st">"EMB"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [?? x 9]
# Database: sqlite 3.51.1 [/var/folders/nm/s3fqdtfj4_vd34n3855h_6j80000gn/T//Rtmp2elTX3/nycflights13.sqlite]
  tailnum  year type               manufacturer model engines seats speed engine
  &lt;chr&gt;   &lt;int&gt; &lt;chr&gt;              &lt;chr&gt;        &lt;chr&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; 
1 N10156   2004 Fixed wing multi … EMBRAER      EMB-…       2    55    NA Turbo…
2 N10575   2002 Fixed wing multi … EMBRAER      EMB-…       2    55    NA Turbo…
3 N11106   2002 Fixed wing multi … EMBRAER      EMB-…       2    55    NA Turbo…
4 N11107   2002 Fixed wing multi … EMBRAER      EMB-…       2    55    NA Turbo…
5 N11109   2002 Fixed wing multi … EMBRAER      EMB-…       2    55    NA Turbo…
6 N11113   2002 Fixed wing multi … EMBRAER      EMB-…       2    55    NA Turbo…</code></pre>
</div>
</div>
<p>Then we will use a join to get all the flights on one of these planes.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span></span>
<span>  <span class="va">airplanes</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">model</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">==</span> <span class="st">"EMB"</span><span class="op">)</span>,</span>
<span>  <span class="va">flights_ev_msp</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"tailnum"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [?? x 27]
# Database: sqlite 3.51.1 [/var/folders/nm/s3fqdtfj4_vd34n3855h_6j80000gn/T//Rtmp2elTX3/nycflights13.sqlite]
   tailnum year.x type      manufacturer model engines seats speed engine year.y
   &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;chr&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;int&gt;
 1 N11107    2002 Fixed wi… EMBRAER      EMB-…       2    55    NA Turbo…   2013
 2 N18120    2003 Fixed wi… EMBRAER      EMB-…       2    55    NA Turbo…   2013
 3 N14977    1999 Fixed wi… EMBRAER      EMB-…       2    55    NA Turbo…   2013
 4 N34110    2002 Fixed wi… EMBRAER      EMB-…       2    55    NA Turbo…   2013
 5 N31131    2003 Fixed wi… EMBRAER      EMB-…       2    55    NA Turbo…   2013
 6 N33182    2005 Fixed wi… EMBRAER      EMB-…       2    55    NA Turbo…   2013
 7 N11137    2003 Fixed wi… EMBRAER      EMB-…       2    55    NA Turbo…   2013
 8 N14168    2004 Fixed wi… EMBRAER      EMB-…       2    55    NA Turbo…   2013
 9 N33182    2005 Fixed wi… EMBRAER      EMB-…       2    55    NA Turbo…   2013
10 N17196    2005 Fixed wi… EMBRAER      EMB-…       2    55    NA Turbo…   2013
# ℹ more rows
# ℹ 17 more variables: month &lt;int&gt;, day &lt;int&gt;, dep_time &lt;int&gt;,
#   sched_dep_time &lt;int&gt;, dep_delay &lt;dbl&gt;, arr_time &lt;int&gt;,
#   sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
#   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
#   minute &lt;dbl&gt;, time_hour &lt;dbl&gt;</code></pre>
</div>
</div>
</section></section><section id="irregular-data" class="level2" data-number="34.2"><h2 data-number="34.2" class="anchored" data-anchor-id="irregular-data">
<span class="header-section-number">34.2</span> Irregular data</h2>
<p>You can download data from online accounts from many services. For example, Spotify will prepare a zip file of the music and podcasts you have listened to over the past year (or longer), with the correct authentication Google will provide data in a structured format. A widely used format for data that is not strictly a table is JavaScript Object Notation (JSON). The R package <code>jsonlite</code> can convert data tables to and from this format.</p>
<p>Here is a relatively short, but complex example (see <a href="https://jsoneditoronline.org/indepth/datasets/json-file-example/">this page</a> for more examples):</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">json_example</span> <span class="op">&lt;-</span> <span class="st">'[{</span></span>
<span><span class="st">  "name": "Chris",</span></span>
<span><span class="st">  "age": 23,</span></span>
<span><span class="st">  "address": {</span></span>
<span><span class="st">    "city": "New York",</span></span>
<span><span class="st">    "country": "America"</span></span>
<span><span class="st">  },</span></span>
<span><span class="st">  "friends": [</span></span>
<span><span class="st">    {</span></span>
<span><span class="st">      "name": "Emily",</span></span>
<span><span class="st">      "hobbies": [ "biking", "music", "gaming" ]</span></span>
<span><span class="st">    },</span></span>
<span><span class="st">    {</span></span>
<span><span class="st">      "name": "John",</span></span>
<span><span class="st">      "hobbies": [ "soccer", "gaming" ]</span></span>
<span><span class="st">    }</span></span>
<span><span class="st">  ]</span></span>
<span><span class="st">}]'</span></span>
<span><span class="va">jsonExample</span> <span class="op">&lt;-</span> <span class="fu">fromJSON</span><span class="op">(</span><span class="va">json_example</span><span class="op">)</span></span>
<span><span class="va">jsonExample</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   name age address.city address.country
1 Chris  23     New York         America
                                             friends
1 Emily, John, biking, music, gaming, soccer, gaming</code></pre>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">flatten</span><span class="op">(</span><span class="va">jsonExample</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   name age                                            friends address.city
1 Chris  23 Emily, John, biking, music, gaming, soccer, gaming     New York
  address.country
1         America</code></pre>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">jsonExample</span><span class="op">$</span><span class="va">friends</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   name               hobbies
1 Emily biking, music, gaming
2  John        soccer, gaming</code></pre>
</div>
</div>
<p>Take a look at the list of repositories for a user on GitHub, for example, <a href="https://github.com/hadley?tab=repositories">Hadley Wickham</a>. As I write, this query gives a list of 356 repositories with lots of metadata including short and full names for repositories, a description, and lots more. Some of these data, for example, data about the user associated with each repository are tables in their own right. One way to structure this data would be using a set of tables and a relational database. The approach used here with JSON is to nest one table inside another.</p>
<p>How are nested tables managed in R data tables? The column of a data table can be, as we’ve seen, text, a number, or a date. It can also be another table. What we do below is <a href="https://api.github.com/users/hadley/repos">read the JSON text</a> (follow the link to see the text format of this data) and then convert it into a table, including nested tables. GitHub just gives the first 30 results; this is common with web or database queries where the number of results could be large. You need to ask for more data using the language of the GitHub API if you want it. When you display the main table, the embedded table appears with prefix in the name (columns named <code>owner.XXX</code>).</p>
<p>(Code output not shown here; run example in your own R session.)</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jeroen.r-universe.dev/jsonlite">jsonlite</a></span><span class="op">)</span></span>
<span><span class="va">data2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html">fromJSON</a></span><span class="op">(</span><span class="st">"https://api.github.com/users/hadley/repos"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data2</span><span class="op">$</span><span class="va">owner</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">data2</span><span class="op">$</span><span class="va">license</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can get the type of each column using <code>typeof</code> and <code>sapply</code>; a column of type list in this example means that column is made of up of tables.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">data2</span>, <span class="va">typeof</span><span class="op">)</span></span>
<span><span class="co"># data2  |&gt; select(where(function(x) typeof(x) == "list")) # to select list columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you don’t want to deal with the nested table, you can flatten it into a regular table. The new columns appear at the right side.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/flatten.html">flatten</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="beyond-csv-other-data-formats" class="level2" data-number="34.3"><h2 data-number="34.3" class="anchored" data-anchor-id="beyond-csv-other-data-formats">
<span class="header-section-number">34.3</span> Beyond CSV: other data formats</h2>
<p>We have relied heavily on the comma separated value format in this course, both because it is a very commonly used format and because it is relatively easy to use. The CSV format has several drawbacks</p>
<ul>
<li>the data type for each column is not described, so the computer software needs to “guess” the data type or you need to describe it explicitly,</li>
<li>there are no standard conventions for variable names, beyond the fact that usually – but not always – the names are given on a single line,</li>
<li>if a text value in a column has a comma in it (for example, an address), then quotation marks are usually used to delineate the content of the column, but then special “escaping” notation is needed to include a quotation mark in text data, and these mechanisms are not always implemented well or correctly,</li>
<li>in some locales, a different separator is used (e.g., a semicolon or tab) and number formatting can differ (the decimal separator can be a period or a comma),</li>
<li>since the file is stored as text, the way the text is encoded will depend on the (human) language used and the country or “locale” where the computer is used, complicating retrieval of the data for someone from another locale,and</li>
<li>large files are relatively slow to read compared to some other formats.</li>
</ul>
<p>We will explore two ways of providing metadata for a CSV file, focusing on variable names, data types, and human-readable descriptions for data. We will then look at data storage formats that permit faster work on large datasets.</p>
<section id="frictionless-metadata-for-tables" class="level3" data-number="34.3.1"><h3 data-number="34.3.1" class="anchored" data-anchor-id="frictionless-metadata-for-tables">
<span class="header-section-number">34.3.1</span> Frictionless metadata for tables</h3>
<p>The frictionless data approach to this problem is to combine a csv file and a metadata file in a “data package”. The metadata includes</p>
<ul>
<li>a short name and descriptive title for the package</li>
<li>a short name and description of each variable in each table</li>
<li>the data type of each variable</li>
</ul>
<p>Here is an example using two tables from the palmerpenguins package.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># remotes::install_github("frictionlessdata/frictionless-r") # or order version from CRAN</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/frictionlessdata/frictionless-r">frictionless</a></span><span class="op">)</span>  </span>
<span><span class="co"># dir.create(here::here("lessons/static/L160"), recursive=TRUE, showWarnings = FALSE)</span></span>
<span><span class="co"># write_csv(penguins, here::here("lessons/static/L160", "penguins.csv"))</span></span>
<span><span class="co"># write_csv(penguins_raw, here::here("lessons/static/L160", "penguins_raw.csv"))</span></span>
<span><span class="va">schema1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/create_schema.html">create_schema</a></span><span class="op">(</span><span class="va">penguins</span><span class="op">)</span></span>
<span><span class="va">schema2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/create_schema.html">create_schema</a></span><span class="op">(</span><span class="va">penguins_raw</span><span class="op">)</span></span>
<span><span class="va">package</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/create_package.html">create_package</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># filename and column names must contain only lower case letters, -, _, .</span></span>
<span><span class="va">package</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/add_resource.html">add_resource</a></span><span class="op">(</span><span class="va">package</span>, resource_name <span class="op">=</span> <span class="st">"penguins"</span>, </span>
<span>                       <span class="co"># data = "static/L160/penguins.csv", </span></span>
<span>                       data <span class="op">=</span> <span class="va">penguins</span>,</span>
<span>                       schema <span class="op">=</span> <span class="va">schema1</span><span class="op">)</span></span>
<span><span class="va">package</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/add_resource.html">add_resource</a></span><span class="op">(</span><span class="va">package</span>, resource_name <span class="op">=</span> <span class="st">"penguins_raw"</span>, </span>
<span>                       <span class="co"># data = "static/L160/penguins_raw.csv", </span></span>
<span>                       data <span class="op">=</span> <span class="va">penguins_raw</span>,</span>
<span>                       schema <span class="op">=</span> <span class="va">schema2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add metadata to package (recent change in library; commented out for now)</span></span>
<span><span class="co"># package$resources[[1]]$schema$missingValues = list('', 'NA')</span></span>
<span><span class="co"># package$resources[[2]]$schema$missingValues = list('', 'NA')</span></span>
<span><span class="co"># package &lt;- append(package, c(name = "palmerpenguins"), after = 0)</span></span>
<span><span class="co"># package &lt;- append(package, c(title = "Data about penguins from Palmer Station, Antarctica"), after = 1)</span></span>
<span><span class="co"># package &lt;- append(package, c(citation = "Horst, A. and Gorman, K. Palmer Penguins Data. https://doi.org/10.5281/zenodo.3960218" ), after = 2)</span></span>
<span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/write_package.html">write_package</a></span><span class="op">(</span><span class="va">package</span>, <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"lessons/static/L160"</span>, <span class="st">"penguins-data-tables"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then you can give this directory (possibly as a zip file) to someone else who can open it with the following functions. You can be assured that the variable names, data types, and descriptions will all be transmitted with your data.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/read_package.html">read_package</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"lessons/static/L160/penguins-data-tables"</span>, <span class="st">"datapackage.json"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/resources.html">resources</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "penguins"     "penguins_raw"</code></pre>
</div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/read_resource.html">read_resource</a></span><span class="op">(</span><span class="va">p</span>, <span class="st">"penguins"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Data are reproduced faithfully except three columns were changed from int to double: flipper_length_mm, body_mass_g, and year.</p>
<p>If your data package is distributed through a website like zenodo, you can read the data directly from that website.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">package</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/read_package.html">read_package</a></span><span class="op">(</span><span class="st">"https://zenodo.org/record/5879096/files/datapackage.json"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/resources.html">resources</a></span><span class="op">(</span><span class="va">package</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "reference-data" "gps"            "acceleration"  </code></pre>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schema_zenodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/get_schema.html">get_schema</a></span><span class="op">(</span><span class="va">package</span>, <span class="st">"reference-data"</span><span class="op">)</span> <span class="co"># contains: name, title, description, type, format for each variable</span></span>
<span><span class="va">schema_zenodo</span><span class="op">$</span><span class="va">fields</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># just a taste of the full output</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$name
[1] "tag-id"

$title
[1] "tag ID"

$description
[1] "A unique identifier for the tag, provided by the data owner. If the data owner does not provide a tag ID, an internal Movebank tag identifier may sometimes be shown. Example: '2342'; Units: none; Entity described: tag"

$type
[1] "string"

$format
[1] "default"

$`skos:exactMatch`
[1] "http://vocab.nerc.ac.uk/collection/MVB/current/MVB000181/2/"</code></pre>
</div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ref_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/frictionless/reference/read_resource.html">read_resource</a></span><span class="op">(</span><span class="va">package</span>, <span class="st">"reference-data"</span><span class="op">)</span> <span class="co"># 13 rows, 24 variables</span></span>
<span><span class="co"># gps &lt;- read_resource(package, "gps") # 73,047 rows, 21 variables</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="csvw" class="level3" data-number="34.3.2"><h3 data-number="34.3.2" class="anchored" data-anchor-id="csvw">
<span class="header-section-number">34.3.2</span> CSVW</h3>
<p>A second solution to the problem of metadata for CSV files was produced by a working group at the World Wide Web Consortium (<a href="https://en.wikipedia.org/wiki/World_Wide_Web_Consortium">W3C</a>). The solution is called CSV on the Web (CSVW).</p>
<p>The <a href="https://robsteranium.github.io/csvwr/">csvwr</a> library implements parts of this standard in R. The goal is to support the reading and writing of annotated CSV tables, to ensure consistent processing and reduce the amount of manual work needed to parse and prepare data before it can be used.</p>
<p>As with frictionless data, the metadata is stored in an accompanying json document and describes</p>
<ul>
<li>the csv dialect (i.e.&nbsp;the choice of field separator or quoting characters),</li>
<li>short and descrpitive variable names,</li>
<li>data types for each variable.</li>
</ul>
<p>Here is an example of creating and reading a CSVW file:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://robsteranium.github.io/csvwr/">csvwr</a></span><span class="op">)</span></span>
<span><span class="co"># Start with a data frame saved as a csv (we did this for the previous example already)</span></span>
<span><span class="co"># write_csv(penguins, here::here("lessons/static/L160", "penguins.csv"))</span></span>
<span><span class="co"># write_csv(penguins_raw, here::here("lessons/static/L160", "penguins_raw.csv"))</span></span>
<span></span>
<span><span class="co"># Derive a schema from the data</span></span>
<span><span class="va">schema1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://robsteranium.github.io/csvwr/reference/derive_table_schema.html">derive_table_schema</a></span><span class="op">(</span><span class="va">penguins</span><span class="op">)</span></span>
<span><span class="va">schema1</span> <span class="co"># Automatically generated; you can improve this information!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$columns
               name            titles datatype
1           species           species   string
2            island            island   string
3    bill_length_mm    bill_length_mm   number
4     bill_depth_mm     bill_depth_mm   number
5 flipper_length_mm flipper_length_mm  integer
6       body_mass_g       body_mass_g  integer
7               sex               sex   string
8              year              year  integer</code></pre>
</div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">schema2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://robsteranium.github.io/csvwr/reference/derive_table_schema.html">derive_table_schema</a></span><span class="op">(</span><span class="va">penguins_raw</span><span class="op">)</span></span>
<span><span class="co"># Alternatively, derive schema from the csv file</span></span>
<span><span class="co"># schema1 &lt;- derive_metadata( here::here("lessons/static/L160", "penguins.csv"))</span></span>
<span><span class="co"># schema2 &lt;- derive_metadata( here::here("lessons/static/L160", "penguins_raw.csv"))</span></span>
<span></span>
<span><span class="co"># Create metadata (as a list)</span></span>
<span><span class="va">table1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"penguins.csv"</span>, tableSchema <span class="op">=</span> <span class="va">schema1</span><span class="op">)</span></span>
<span><span class="va">table2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"penguins_raw.csv"</span>, tableSchema <span class="op">=</span> <span class="va">schema2</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://robsteranium.github.io/csvwr/reference/create_metadata.html">create_metadata</a></span><span class="op">(</span>tables<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">table1</span>, <span class="va">table2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Serialise the metadata to JSON</span></span>
<span><span class="va">j</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html">toJSON</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Write the json to a file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">j</span>, file<span class="op">=</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"lessons/static/L160"</span>, <span class="st">"penguins-csvw-metadata.json"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Read the data from the files</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">penguins_both_csvw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://robsteranium.github.io/csvwr/reference/read_csvw.html">read_csvw</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"lessons/static/L160"</span>, <span class="st">"penguins-csvw-metadata.json"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">penguins_csvw</span> <span class="op">&lt;-</span> <span class="va">penguins_both_csvw</span><span class="op">$</span><span class="va">tables</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">dataframe</span></span>
<span><span class="va">penguins_raw_csvw</span> <span class="op">&lt;-</span> <span class="va">penguins_both_csvw</span><span class="op">$</span><span class="va">tables</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">dataframe</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data are reproduced faithfully, except factor variables in the original data are read as text from the CSVW and some column names have been changed in <code>penguins_raw</code> (e.g., spaces changed to periods).</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">penguins</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">penguins_csvw</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Component \"species\": 'current' is not a factor"
[2] "Component \"island\": 'current' is not a factor" 
[3] "Component \"sex\": 'current' is not a factor"    </code></pre>
</div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">penguins_raw</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">penguins_raw_csvw</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Names: 10 string mismatches"                                      
[2] "Attributes: &lt; Length mismatch: comparison on first 2 components &gt;"</code></pre>
</div>
</div>
</section><section id="speed-and-metadata-solution" class="level3" data-number="34.3.3"><h3 data-number="34.3.3" class="anchored" data-anchor-id="speed-and-metadata-solution">
<span class="header-section-number">34.3.3</span> Speed and metadata solution</h3>
<p>A second problem with CSV is that reading the data from disk into memory is slow for large files. There are two reasons: the text data is larger than equivalent information stored in a binary format, and the reading process requires the software to infer the types of the data. Here I will introduce alternative storage formats that address both problems. The first is a binary format called <a href="https://en.wikipedia.org/wiki/Apache_Parquet">parquet</a> made by the non-profit <a href="https://en.wikipedia.org/wiki/The_Apache_Software_Foundation">Apache Software Foundation</a> (where the earliest popular web servers were developed). The second is a database format called <a href="https://en.wikipedia.org/wiki/SQLite">SQLite</a> which is freely and widely available. It is the most widely used database software in the world and is an archival format <a href="https://www.loc.gov/preservation/resources/rfs/data.html">recommended</a> by the US Library of Congress. Both are easy to use with R.</p>
<p>A file with 1 million floating point numbers takes this much storage on disk: csv (18.4 MB), compressed csv (csv.gz, 8.5 MB), SQLite (9.3 MB), parquet (6.9 MB), and feather (5.5 MB). The binary formats parquet and feather are both smaller and faster to work with than a compressed text format (csv.gz).</p>
<p>Here I demonstrate creating and reading these files.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/">arrow</a></span><span class="op">)</span> <span class="co"># for parquet and arrow format files</span></span>
<span><span class="co"># On M1/2/3 Mac, instead of installing from CRAN do the following</span></span>
<span><span class="co"># install.packages('arrow',  repos = c('https://apache.r-universe.dev', 'https://cloud.r-project.org'))</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org">RSQLite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/">dbplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1000000</span><span class="op">)</span>, <span class="fl">100000</span>, <span class="fl">10</span><span class="op">)</span> </span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span>.name_repair <span class="op">=</span> <span class="st">"unique"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># parquet compresses data on columns, try the nycflights13 data with 6.4m "entries" (336,776 observations of 19 variables)</span></span>
<span><span class="co"># 4.8 MB parquet, 9.9 MV feather, 29.6 MB csv, 7.9 MB csv.gz, 21.1 MB SQLite</span></span>
<span><span class="co"># df &lt;- nycflights13::flights</span></span>
<span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"static/L160/test.gz.parquet"</span>, compression<span class="op">=</span><span class="st">"gzip"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_feather.html">write_feather</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"static/L160/test.feather"</span>, version<span class="op">=</span><span class="fl">2</span>, compression <span class="op">=</span> <span class="st">"zstd"</span><span class="op">)</span> <span class="co"># lz4, zstd, uncompressed</span></span>
<span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"static/L160/test.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">df</span>, <span class="st">"static/L160/test.csv.gz"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"static/L160/test.sqlite"</span><span class="op">)</span></span>
<span><span class="co"># dbRemoveTable(con, "df")</span></span>
<span><span class="fu">dbWriteTable</span><span class="op">(</span><span class="va">con</span>, <span class="st">"df"</span>, <span class="va">df</span>, overwrite<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The speeds of reading each file type, relative to csv (smaller is faster) is: csv (1.0), parquet (0.4), SQLite (0.46).</p>
<p>This code block opens each file – uncomment the line you want to use.</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># sw &lt;- read_csv("static/L160/test.csv.gz", show_col_types = FALSE)</span></span>
<span><span class="co"># sw &lt;- read_csv("static/L160/test.csv", show_col_types = FALSE)</span></span>
<span><span class="va">sw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet</a></span><span class="op">(</span><span class="st">"static/L160/test.gz.parquet"</span><span class="op">)</span></span>
<span><span class="co"># sw &lt;- read_feather("static/L160/test.feather")</span></span>
<span><span class="co"># con &lt;- dbConnect(SQLite(), "static/L160/test.sqlite"); sw &lt;- tbl(con, "df")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This code block reads data and does a dplyr calculation:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sw</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">a</span> <span class="op">&lt;</span> <span class="fl">0.1</span>, <span class="va">f</span> <span class="op">&gt;</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">b</span>, <span class="va">c</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>,</span>
<span>             mean_c <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  mean_b mean_c
   &lt;dbl&gt;  &lt;dbl&gt;
1  0.511  0.502</code></pre>
</div>
</div>
<p>It is good practice to close the connection to your SQLite database when you are done.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in connection_release(conn@ptr): Already disconnected</code></pre>
</div>
</div>
<p>Remove files to clean up your storage, since you don’t need any of these files.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"static/L160/test.gz.parquet"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"static/L160/test.feather"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"static/L160/test.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"static/L160/test.csv.gz"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"static/L160/test.sqlite"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="packages-used" class="level2" data-number="34.4"><h2 data-number="34.4" class="anchored" data-anchor-id="packages-used">
<span class="header-section-number">34.4</span> Packages used</h2>
<p>In addition to the <code>tidyverse</code> and <code>palmerpenguins</code>, in this lesson I have used</p>
<ul>
<li>
<code>dbplyr</code> for using dplyr functions on databases (“db”)</li>
<li>
<code>nycflights13</code> for access to a relatively large dataset</li>
<li>
<code>jsonlite</code> for working with JSON data</li>
<li><code>frictionless</code></li>
<li><code>csvwr</code></li>
<li>
<code>arrow</code> for the parquet and feather formats</li>
<li>
<code>RSQLite</code> for SQLite database creation and access</li>
</ul></section><section id="references" class="level2" data-number="34.5"><h2 data-number="34.5" class="anchored" data-anchor-id="references">
<span class="header-section-number">34.5</span> References</h2>
<ul>
<li>For more on Frictionless data packages, see its <a href="https://github.com/frictionlessdata/frictionless-r">GitHub page</a> or doi <a href="https://doi.org/10.5281/zenodo.5815355">10.5281/zenodo.5815355</a>
</li>
<li>A second, more elaborate package to create frictionless data packages is the <a href="https://github.com/frictionlessdata/datapackage-r">datapackage</a> tool</li>
<li>rOpenSci has a package <a href="https://docs.ropensci.org/deposits/index.html">deposits</a> to help ensure data submitted to repositories are complete and well documented</li>
<li>Another approach to improving CSV files is the CSV on the Web (CSVW) r package: <a href="https://robsteranium.github.io/csvwr/">CSVWR</a>
</li>
<li>The R4DS chapters on <a href="https://r4ds.hadley.nz/databases">databases</a>, <a href="https://r4ds.hadley.nz/arrow">arrow format</a>, and <a href="https://r4ds.hadley.nz/rectangling">hierarchical data</a>. In particular the chapter on hierarchical data has advice on working with JSON files.</li>
<li>More a more detailed approach to metadata, see <a href="https://annakrystalli.me/rrresearchACCE20/dataspice.html">Dataspice</a>
</li>
<li>Yet another approach to metadata is implemented by the <a href="https://cran.r-project.org/web/packages/yamlet/vignettes/yamlet-introduction.html">yamlet</a> package</li>
</ul>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../lessons/133-themes.html" class="pagination-link" aria-label="Themes">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Themes</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../lessons/130-graphics-output.html" class="pagination-link" aria-label="Graphics formatting">
        <span class="nav-page-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Graphics formatting</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>